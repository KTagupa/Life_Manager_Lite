<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Urgency Flow: Viewer</title>
    <style>
        :root {
            --bg-color: #0c1812;
            --card-bg: #15261d;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #3b82f6;
            --critical: #ffd700;
            --urgent: #ef4444;
            --ready: #10b981;
            --border: #333;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- PULL TO REFRESH UI --- */
        #ptr-indicator {
            height: 0;
            overflow: hidden;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--accent);
            transition: height 0.2s;
        }

        /* --- HEADER --- */
        header {
            padding: 15px;
            background: rgba(21, 38, 29, 0.95);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
        }

        .search-bar {
            flex-grow: 1;
            background: #08100c;
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 8px 15px;
            color: #fff;
            font-size: 14px;
        }

        /* --- MAIN CONTENT --- */
        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 140px; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .view-section { display: none; }
        .view-section.active { display: block; }

        /* --- CARDS --- */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .task-card { border-left: 4px solid #555; }
        .task-card.urgent { border-left-color: var(--urgent); }
        
        /* Habit Styling */
        .habit-card { cursor: pointer; transition: transform 0.1s; position: relative; }
        .habit-card:active { transform: scale(0.98); }
        .habit-check { position: absolute; right: 15px; top: 15px; font-size: 18px; }

        /* --- ACTIVE AGENDA BAR (Persistent) --- */
        #active-agenda-bar {
            position: fixed;
            bottom: var(--nav-height); 
            left: 0; width: 100%;
            background: rgba(16, 185, 129, 0.2); 
            border-top: 1px solid var(--ready);
            backdrop-filter: blur(8px);
            padding: 12px 15px;
            display: none; 
            align-items: center;
            justify-content: space-between;
            z-index: 95;
        }
        #active-agenda-bar.visible { display: flex; }
        .next-up { font-size: 10px; color: #888; margin-top: 2px; }

        /* --- NAV BAR --- */
        nav {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: #111;
            border-top: 1px solid var(--border);
            display: flex;
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 10px;
            background: none; border: none;
        }
        .nav-item.active { color: var(--accent); }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: flex-end; 
        }
        .modal-overlay.open { display: flex; }
        .modal-sheet {
            background: #1a1a1a; width: 100%; max-height: 85vh;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 20px; overflow-y: auto;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

    <div id="ptr-indicator">Pull to refresh...</div>

    <header>
        <input type="text" class="search-bar" id="search-input" placeholder="Search..." onkeyup="handleSearch()">
        <button onclick="openSettings()" style="background:none; border:none; font-size:20px;">‚òÅÔ∏è</button>
    </header>

    <main id="main-container">
        <div id="view-tasks" class="view-section active"></div>
        <div id="view-agenda" class="view-section"></div>
        <div id="view-habits" class="view-section"></div>
        <div id="view-notes" class="view-section"></div>
        <div id="view-inbox" class="view-section"></div>
    </main>

    <div id="active-agenda-bar">
        <div>
            <div id="np-title" style="font-weight:600; font-size:14px; color:#fff;">Task</div>
            <div id="next-up-text" class="next-up">Next: --</div>
        </div>
        <div style="text-align:right;">
            <span id="np-time" style="font-family:monospace; color:var(--ready); font-size:12px; font-weight:bold;">0m left</span>
        </div>
    </div>

    <nav>
        <button class="nav-item active" onclick="switchView('tasks')"><span>‚ö°</span><span>Tasks</span></button>
        <button class="nav-item" onclick="switchView('agenda')"><span>üìÖ</span><span>Agenda</span></button>
        <button class="nav-item" onclick="switchView('habits')"><span>‚úÖ</span><span>Habits</span></button>
        <button class="nav-item" onclick="switchView('notes')"><span>üìù</span><span>Notes</span></button>
    </nav>

    <div id="detail-modal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3 id="modal-title"></h3>
            <div id="modal-content" style="font-size:14px; line-height:1.6; color:#ccc;"></div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="closeSettings()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <h3>Sync Settings</h3>
            <input type="password" id="gh-token" placeholder="GitHub Token">
            <input type="text" id="gist-id" placeholder="Gist ID">
            <button class="btn-primary" onclick="pullData()" style="width:100%; padding:12px; background:var(--accent); border:none; color:white; border-radius:8px;">Sync Now</button>
            <div id="sync-status" style="text-align:center; margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <script>
        let data = { nodes: [], habits: [], agenda: [], notes: [], inbox: [] };
        let localHabitLogs = JSON.parse(localStorage.getItem('uf_local_habits') || '{}');
        let lastKnownAgendaTaskId = null;
        let wakeLock = null;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- FEATURE: PULL TO REFRESH ---
        let touchStart = 0;
        const main = document.getElementById('main-container');
        main.addEventListener('touchstart', e => { touchStart = e.touches[0].pageY; });
        main.addEventListener('touchmove', e => {
            const touch = e.touches[0].pageY;
            if (main.scrollTop === 0 && touch > touchStart) {
                const pullDist = Math.min((touch - touchStart) / 2, 60);
                document.getElementById('ptr-indicator').style.height = pullDist + 'px';
            }
        });
        main.addEventListener('touchend', () => {
            if (parseInt(document.getElementById('ptr-indicator').style.height) > 50) pullData();
            document.getElementById('ptr-indicator').style.height = '0px';
        });

        // --- FEATURE: SCREEN WAKE LOCK ---
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.log("WakeLock failed"); }
        }

        // --- AUDIO ---
        async function playAlert() {
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(523, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1046, audioCtx.currentTime + 0.5);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }

        // --- LOGIC ---
        function checkActiveAgenda() {
            const now = new Date();
            const sortedAgenda = (data.agenda || []).sort((a,b) => new Date(a.start) - new Date(b.start));
            const currentIdx = sortedAgenda.findIndex(s => now >= new Date(s.start) && now <= new Date(s.end));
            const bar = document.getElementById('active-agenda-bar');

            if (currentIdx !== -1) {
                const slot = sortedAgenda[currentIdx];
                const task = data.nodes.find(n => n.id === slot.taskId);
                
                // Sound logic
                if (slot.taskId !== lastKnownAgendaTaskId) {
                    playAlert();
                    lastKnownAgendaTaskId = slot.taskId;
                    requestWakeLock(); // Keep screen on when a task starts
                }

                document.getElementById('np-title').innerText = task ? task.title : "Unknown";
                const timeLeft = Math.ceil((new Date(slot.end) - now) / 60000);
                document.getElementById('np-time').innerText = `${timeLeft}m left`;
                
                // FEATURE: NEXT UP PREVIEW
                const nextSlot = sortedAgenda[currentIdx + 1];
                if (nextSlot) {
                    const nextTask = data.nodes.find(n => n.id === nextSlot.taskId);
                    document.getElementById('next-up-text').innerText = `Next: ${nextTask?.title || 'Scheduled Task'}`;
                } else {
                    document.getElementById('next-up-text').innerText = "End of Agenda";
                }

                bar.classList.add('visible');
            } else {
                bar.classList.remove('visible');
                lastKnownAgendaTaskId = null;
            }
        }

        // --- FEATURE: LOCAL HABIT TOGGLE ---
        function toggleHabitLocal(habitId) {
            const today = new Date().toISOString().split('T')[0];
            if (!localHabitLogs[today]) localHabitLogs[today] = {};
            
            // Toggle between 0 and 1 (Simple check)
            localHabitLogs[today][habitId] = localHabitLogs[today][habitId] ? 0 : 1;
            localStorage.setItem('uf_local_habits', JSON.stringify(localHabitLogs));
            renderHabits();
        }

        function renderHabits() {
            const container = document.getElementById('view-habits');
            container.innerHTML = '<h3>Daily Habits</h3>';
            const today = new Date().toISOString().split('T')[0];

            (data.habits || []).forEach(h => {
                // Merge synced history with local overrides
                const syncedVal = (h.history && h.history[today]) ? 1 : 0;
                const localVal = (localHabitLogs[today] && localHabitLogs[today][h.id] !== undefined) 
                                 ? localHabitLogs[today][h.id] 
                                 : syncedVal;

                const isDone = localVal >= (h.target || 1);
                const card = document.createElement('div');
                card.className = 'card habit-card';
                card.style.borderLeft = isDone ? '4px solid var(--ready)' : '4px solid var(--border)';
                card.onclick = () => toggleHabitLocal(h.id);
                card.innerHTML = `
                    <div style="font-weight:bold;">${h.title}</div>
                    <div style="font-size:11px; color:#666;">Local Toggle (Doesn't sync back)</div>
                    <div class="habit-check">${isDone ? '‚úÖ' : '‚≠ï'}</div>
                `;
                container.appendChild(card);
            });
        }

        // --- STANDARD APP LOGIC ---
        function switchView(v) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`view-${v}`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function renderTasks() {
            const container = document.getElementById('view-tasks');
            container.innerHTML = '';
            data.nodes.filter(n => !n.completed).forEach(n => {
                const d = document.createElement('div');
                d.className = `card task-card ${n.isManualUrgent ? 'urgent' : ''}`;
                d.onclick = () => openTaskModal(n);
                d.innerHTML = `<div style="font-weight:600;">${n.title}</div>`;
                container.appendChild(d);
            });
        }

        async function pullData() {
            const token = localStorage.getItem('uf_token');
            const gistId = localStorage.getItem('uf_gist');
            if(!token || !gistId) return;
            try {
                const resp = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: { 'Authorization': `token ${token}` }
                });
                const json = await resp.json();
                const content = JSON.parse(json.files['urgency_flow_data.json'].content);
                data = Array.isArray(content) ? { ...data, nodes: content } : { ...data, ...content };
                localStorage.setItem('urgencyFlowData', JSON.stringify(data));
                renderTasks(); renderHabits(); checkActiveAgenda();
            } catch(e) { console.error(e); }
        }

        function openTaskModal(n) {
            document.getElementById('modal-title').innerText = n.title;
            document.getElementById('modal-content').innerHTML = marked.parse(n.description || '*No description*');
            document.getElementById('detail-modal').classList.add('open');
        }

        function closeModal() { document.getElementById('detail-modal').classList.remove('open'); }
        function openSettings() { document.getElementById('settings-modal').classList.add('open'); }
        function closeSettings() { document.getElementById('settings-modal').classList.remove('open'); }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            const raw = localStorage.getItem('urgencyFlowData');
            if(raw) data = JSON.parse(raw);
            renderTasks();
            renderHabits();
            setInterval(checkActiveAgenda, 5000);
            checkActiveAgenda();
        });
    </script>
</body>
</html>
