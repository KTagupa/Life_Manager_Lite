<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0c1812">
    <title>Urgency Flow: Mobile Lite</title>
    <style>
        :root {
            /* Calming Dark Green Theme */
            --bg-color: #0c1812;
            --dots-color: #24342b;
            --panel-bg: #15261d;
            
            /* Preserved Colors */
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --border: #333;
            
            --node-bg: #2d2d2d;
            --node-border: #444;
            --node-selected: #3b82f6;
            
            /* Logic Colors */
            --critical-path: #ffd700; /* Gold */
            --ready-color: #10b981;   /* Green */
            --blocked-color: #ef4444; /* Red */
            --soft-dep-color: #666;

            /* Mobile Specifics */
            --nav-height: 60px;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(var(--dots-color) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic viewport height */
            width: 100vw;
            display: flex;
            flex-direction: column;
            touch-action: none; /* Prevent browser zooming/scrolling */
        }

        /* --- MOBILE LAYOUT --- */
        
        /* Top Header for Secondary Actions */
        #top-header {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 50px;
            padding: 0 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            background: linear-gradient(to bottom, rgba(12,24,18,0.9), transparent);
            pointer-events: none; /* Let clicks pass through to canvas where empty */
        }
        
        #top-header > * { pointer-events: auto; }

        .app-title { font-weight: 800; font-size: 16px; opacity: 0.7; letter-spacing: 1px; }

        /* Bottom Nav Bar */
        #bottom-nav {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: calc(var(--nav-height) + var(--safe-area-bottom));
            background: #111;
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 8px;
            z-index: 200;
            padding-bottom: var(--safe-area-bottom);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #888;
            background: none;
            border: none;
            gap: 4px;
            width: 60px;
            cursor: pointer;
        }
        
        .nav-item.active { color: var(--accent); }
        .nav-item svg { width: 24px; height: 24px; fill: currentColor; }

        .nav-fab {
            width: 48px; height: 48px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: -20px; /* Pop out effect */
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.4);
            border: 2px solid #111;
        }
        .nav-fab svg { width: 28px; height: 28px; fill: white; }

        /* --- BOTTOM SHEET INSPECTOR --- */
        #inspector {
            position: fixed;
            left: 0; right: 0; bottom: 0;
            height: 75vh; /* Takes up 75% of screen */
            background: var(--panel-bg);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 300;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
            border-top: 1px solid #333;
        }

        #inspector.visible { transform: translateY(0); }
        
        .drag-handle {
            width: 40px; height: 5px; background: #444;
            border-radius: 3px; margin: 10px auto; flex-shrink: 0;
        }

        /* --- FULL SCREEN OVERLAYS (Goals, Notes, etc) --- */
        .fullscreen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color);
            z-index: 400;
            display: flex; flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .fullscreen-overlay.visible { transform: translateY(0); }

        .overlay-header {
            padding: 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: #1a1a1a;
            border-bottom: 1px solid #333;
            height: 60px;
            flex-shrink: 0;
            width: 100%; /* Ensure full width */
        }
        .overlay-title { font-weight: bold; font-size: 18px; }
        .close-btn { background: none; border: none; font-size: 24px; color: #888; padding: 10px; }

        /* --- MAIN CANVAS --- */
        #graph-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            touch-action: none;
            width: 100%; height: 100%;
        }
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        path { fill: none; stroke-width: 2; transition: stroke 0.3s; }
        path.soft { stroke-dasharray: 5, 5; }
        path.critical { stroke: var(--critical-path) !important; stroke-width: 3; }

        /* --- NODES --- */
        .node { 
            position: absolute; width: 160px; /* Slightly smaller for mobile */
            background: var(--node-bg); border: 1px solid var(--node-border); 
            border-radius: 8px; padding: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); 
            z-index: 10; display: flex; flex-direction: column; gap: 4px;
        }
        .node.selected { border: 2px solid var(--node-selected); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .node.critical { border-color: var(--critical-path); }
        .node.critical-urgent { border-color: #ff4d4d; box-shadow: 0 0 10px rgba(255, 77, 77, 0.3); }
        .node.blocked { opacity: 0.6; border-style: dashed; }
        .node.completed { background: #1e3a2f; border-color: #10b981; opacity: 0.7; }
        
        .node-header { font-size: 13px; font-weight: 600; line-height: 1.3; }
        .node-meta { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 2px; }
        
        .badge { padding: 2px 4px; border-radius: 3px; font-size: 9px; background: #333; color: #aaa; }
        .badge.urgent-badge { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge.critical-badge { background: rgba(255, 215, 0, 0.2); color: var(--critical-path); }
        .badge.time-badge { background: #374151; color: #fff; font-family: monospace; }
        .badge.time-badge.active { background: #991b1b; animation: pulse 2s infinite; }

        .progress-container { height: 3px; background: #444; margin-top: 4px; border-radius: 2px; }
        .progress-bar { height: 100%; background: var(--ready-color); width: 0%; transition: width 0.3s; }

        /* --- FORMS & LISTS --- */
        .panel-content { padding: 20px; overflow-y: auto; height: 100%; padding-bottom: 80px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 11px; margin-bottom: 6px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        input, textarea, select { 
            width: 100%; background: #222; border: 1px solid #444; 
            color: #fff; padding: 12px; border-radius: 8px; 
            font-size: 16px; /* Prevents iOS zoom */
            font-family: inherit; 
        }
        .btn { 
            background: #2a2a2a; border: 1px solid #444; color: #ddd; 
            padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600;
            width: 100%; display: block; text-align: center; margin-bottom: 5px;
            cursor: pointer;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444; }
        
        /* --- MENU OVERLAY (Settings) --- */
        /* Fixed: Removed conflicting centering that broke layout */
        #menu-overlay { 
            background: rgba(0,0,0,0.95); 
        }
        
        #menu-overlay .panel-content {
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            padding: 30px; 
            text-align: center;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Inbox List Items (Fixed Truncation) */
        .inbox-item { 
            background: #222; padding: 12px; margin-bottom: 8px; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        .inbox-item span:first-child {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }
        .inbox-actions { display: flex; gap: 15px; font-size: 18px; flex-shrink: 0; }

        /* Goal Tree (Improved Tap Targets) */
        .goal-node { margin-bottom: 8px; }
        .goal-content { background: #222; padding: 8px 10px; border-radius: 6px; display: flex; align-items: center; }
        .goal-text { border: none; background: transparent; color: white; font-size: 14px; flex-grow: 1; margin-left: 10px; }
        .goal-children { margin-left: 15px; border-left: 2px solid #333; padding-left: 10px; margin-top: 5px; }

        /* Notification Toast */
        #notification {
            position: fixed; top: 70px; left: 50%; transform: translateX(-50%);
            background: var(--accent); color: white; padding: 8px 16px;
            border-radius: 20px; font-size: 12px; opacity: 0; 
            pointer-events: none; z-index: 1000; transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

    </style>
</head>
<body>

    <!-- TOP HEADER -->
    <div id="top-header">
        <div class="app-title">Urgency Flow</div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="nav-item" onclick="toggleMenu()" style="width: auto;">
                <!-- Sync/Cloud Icon -->
                <svg viewBox="0 0 24 24" style="fill: var(--accent);"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM19 18H6c-2.21 0-4-1.79-4-4 0-2.05 1.53-3.76 3.56-3.97l1.07-.11.5-.95C8.08 7.14 9.94 6 12 6c2.62 0 4.88 1.86 5.39 4.43l.3 1.5 1.53.11c1.56.1 2.78 1.41 2.78 2.96 0 1.65-1.35 3-3 3z"/></svg>
            </button>
            <button class="nav-item" onclick="toggleMenu()" style="width: auto;">
                <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
            </button>
        </div>
    </div>

    <!-- CANVAS -->
    <div id="graph-container">
        <div id="transform-layer" style="transform-origin: 0 0; position: absolute; top:0; left:0; width:100%; height:100%;">
            <svg id="connections"></svg>
            <div id="nodes-layer"></div>
        </div>
    </div>

    <!-- BOTTOM NAV -->
    <div id="bottom-nav">
        <button class="nav-item" onclick="fitView()">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            <span>Focus</span>
        </button>
        <button class="nav-item" onclick="toggleGoals()">
            <svg viewBox="0 0 24 24"><path d="M19.03 3.56c-1.67-1.39-3.74-2.3-6.03-2.51v2.01c1.73.19 3.31.88 4.61 1.92l1.42-1.42zM11 3.06V1.05c-2.29.2-4.36 1.12-6.03 2.51l1.42 1.42C7.69 3.94 9.27 3.25 11 3.06zM4.98 6.39L3.56 4.97C2.17 6.64 1.26 8.71 1.05 11h2.01c.19-1.73.88-3.31 1.92-4.61zM20.94 11h2.01c-.21-2.29-1.12-4.36-2.51-6.03l-1.42 1.42c1.04 1.3 1.73 2.88 1.92 4.61zM7 12l5 5 5-5H7z"/></svg>
            <span>Goals</span>
        </button>
        
        <button class="nav-item nav-fab" onclick="addNode()">
            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
        </button>

        <button class="nav-item" onclick="toggleInbox()">
            <svg viewBox="0 0 24 24"><path d="M19 3H4.99c-1.11 0-1.98.89-1.98 2L3 19c0 1.1.88 2 1.99 2H19c1.1 0 2-.88 2-2V5c0-1.11-.9-2-2-2zm0 12h-4c0 1.66-1.35 3-3 3s-3-1.34-3-3H4.99V5H19v10z"/></svg>
            <span>Inbox</span>
        </button>
        <button class="nav-item" onclick="toggleNotesPanel()">
            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
            <span>Notes</span>
        </button>
    </div>

    <!-- INSPECTOR SHEET -->
    <div id="inspector">
        <div class="drag-handle" onclick="deselectNode()"></div>
        <div class="panel-content" id="insp-content">
            <!-- Dynamic Content -->
        </div>
    </div>

    <!-- FULL SCREEN OVERLAYS -->
    
    <!-- Goals Overlay -->
    <div id="goals-overlay" class="fullscreen-overlay">
        <div class="overlay-header">
            <span class="overlay-title">üéØ Life Goals</span>
            <button class="close-btn" onclick="toggleGoals()">‚úï</button>
        </div>
        <div class="panel-content">
             <div class="year-nav" style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <button class="btn" style="width:auto" onclick="changeGoalYear(-1)">&lt;</button>
                <span id="goals-year-display" style="font-weight:bold; font-size:20px;">2024</span>
                <button class="btn" style="width:auto" onclick="changeGoalYear(1)">&gt;</button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="new-goal-input" placeholder="New root goal..." onkeypress="if(event.key==='Enter') addRootGoal()">
                <button class="btn btn-primary" style="width:auto" onclick="addRootGoal()">Add</button>
            </div>
            <div id="goal-tree-container"></div>
        </div>
    </div>

    <!-- Inbox Overlay -->
    <div id="inbox-overlay" class="fullscreen-overlay">
        <div class="overlay-header">
            <span class="overlay-title">üì• Inbox / Backlog</span>
            <button class="close-btn" onclick="toggleInbox()">‚úï</button>
        </div>
        <div class="panel-content">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="inbox-input" placeholder="Quick task..." onkeypress="if(event.key==='Enter') addToInbox()">
                <button class="btn btn-primary" style="width:auto" onclick="addToInbox()">Add</button>
            </div>
            <div id="inbox-list"></div>
        </div>
    </div>

    <!-- Notes Overlay -->
    <div id="notes-overlay" class="fullscreen-overlay">
        <div class="overlay-header">
            <span class="overlay-title">üìù Notes</span>
            <button class="close-btn" onclick="toggleNotesPanel()">‚úï</button>
        </div>
        <div class="panel-content">
            <button class="btn btn-primary" onclick="createNewNote()">+ New Independent Note</button>
            <div id="notes-list-container" style="margin-top:15px;"></div>
        </div>
        <!-- Simple Modal Editor inside Overlay -->
        <div id="note-editor" class="fullscreen-overlay" style="z-index: 500;">
            <div class="overlay-header">
                <button class="close-btn" onclick="closeNoteEditor()">‚Üê Back</button>
                <span class="overlay-title">Edit Note</span>
                <button class="btn btn-danger" style="width:auto; padding:5px 10px;" onclick="deleteCurrentNote()">Delete</button>
            </div>
            <div style="display:flex; flex-direction:column; height:100%; padding:15px; gap:10px;">
                <input type="text" id="note-title-input" placeholder="Title" oninput="saveCurrentNote()">
                <textarea id="note-body-input" style="flex-grow:1; resize:none;" placeholder="Start typing..." oninput="saveCurrentNote()"></textarea>
            </div>
        </div>
    </div>

    <!-- Menu Overlay -->
    <div id="menu-overlay" class="fullscreen-overlay">
        <div class="overlay-header">
            <span class="overlay-title">‚öôÔ∏è Menu</span>
            <button class="close-btn" onclick="toggleMenu()">‚úï</button>
        </div>
        <div class="panel-content">
            <button class="btn" onclick="toggleArchivePanel()">üóÑÔ∏è View Archive</button>
            <button class="btn" onclick="toggleHeatmap()">üìÖ Activity Heatmap</button>
            <hr style="border-color:#333; width:100%; margin:20px 0;">
            
            <div style="background:#222; padding:15px; border-radius:8px; margin-bottom:15px;">
                <label>GitHub Sync (Private Gist)</label>
                <input type="password" id="github-token" placeholder="Token" onchange="saveGithubToken(this.value)" style="margin-bottom:10px;">
                <input type="text" id="gist-id" placeholder="Gist ID" readonly style="margin-bottom:10px; opacity:0.5;">
                <div style="display:flex; gap:10px;">
                    <button class="btn" onclick="pullFromGist()">‚¨á Pull</button>
                    <button class="btn btn-primary" onclick="pushToGist()">‚¨Ü Push</button>
                </div>
                <div id="sync-status" style="margin-top:5px; font-size:11px; text-align:center;"></div>
            </div>

            <button class="btn" onclick="saveData(true)">üíæ Export JSON</button>
            <button class="btn" onclick="document.getElementById('file-input').click()">üìÇ Import JSON</button>
            <button class="btn btn-danger" onclick="clearData()">‚ö†Ô∏è Reset App</button>
        </div>
    </div>

    <!-- Archive Overlay -->
    <div id="archive-overlay" class="fullscreen-overlay">
        <div class="overlay-header">
            <span class="overlay-title">üóÑÔ∏è Archive</span>
            <button class="close-btn" onclick="toggleArchivePanel()">‚úï</button>
        </div>
        <div class="panel-content" id="archive-list-container"></div>
    </div>
    
    <!-- Heatmap Overlay -->
    <div id="heatmap-overlay" class="fullscreen-overlay">
        <div class="overlay-header">
            <span class="overlay-title">Activity</span>
            <button class="close-btn" onclick="toggleHeatmap()">‚úï</button>
        </div>
        <div class="panel-content">
             <div class="heatmap-controls" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn" style="width:auto" onclick="changeHeatmapYear(-1)">&lt;</button>
                <h2 id="heatmap-title" style="margin: 0; font-size:16px;">2024</h2>
                <button class="btn" style="width:auto" onclick="changeHeatmapYear(1)">&gt;</button>
            </div>
            <div id="heatmap-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;"></div>
        </div>
    </div>

    <!-- Hidden Input -->
    <input type="file" id="file-input" style="display:none" onchange="loadFile(this)">
    
    <!-- Notification -->
    <div id="notification">State Saved</div>

<script>
    // --- STATE MANAGEMENT ---
    let nodes = [];
    let archivedNodes = [];
    let inbox = []; 
    let lifeGoals = {}; 
    let notes = []; 
    let currentGoalYear = new Date().getFullYear();
    let selectedNodeId = null; 
    let currentEditingNoteId = null;
    let scale = 1;
    let panX = 0;
    let panY = 0;
    
    // Sync State
    let githubToken = '';
    let gistId = '';
    const GIST_FILENAME = 'urgency_flow_data.json';
    const ARCHIVE_THRESHOLD_MS = 15 * 24 * 60 * 60 * 1000; 
    
    // Interaction State
    let isDragging = false;
    let isPanning = false;
    let dragStartX, dragStartY;
    let draggedNodeId = null;
    
    // Touch Logic
    let lastTouchX = 0, lastTouchY = 0;
    let initialPinchDist = null;
    let initialScale = 1;
    let currentHeatmapYear = new Date().getFullYear();

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        loadFromStorage();
        if (nodes.length === 0 && inbox.length === 0 && Object.keys(lifeGoals).length === 0 && archivedNodes.length === 0) {
            initDemoData();
        }
        
        if(githubToken) document.getElementById('github-token').value = githubToken;
        if(gistId) document.getElementById('gist-id').value = gistId;
        
        checkAutoArchive(); 
        updateCalculations();
        
        // Center view initially
        panX = window.innerWidth / 2 - 100;
        panY = window.innerHeight / 2 - 100;

        render(); 
        setupInteractions();
        setInterval(tickTimers, 1000);
        setInterval(checkAutoArchive, 60000); 
    });

    // --- UI TOGGLERS (Adapted for Mobile Overlays) ---
    function toggleMenu() { toggleOverlay('menu-overlay'); }
    function toggleGoals() { renderGoals(); toggleOverlay('goals-overlay'); }
    function toggleInbox() { renderInbox(); toggleOverlay('inbox-overlay'); }
    function toggleNotesPanel() { renderNotesList(); toggleOverlay('notes-overlay'); }
    function toggleArchivePanel() { renderArchiveList(); toggleOverlay('archive-overlay'); }
    function toggleHeatmap() { renderHeatmap(); toggleOverlay('heatmap-overlay'); }
    
    function toggleOverlay(id) {
        const el = document.getElementById(id);
        const isVisible = el.classList.contains('visible');
        // Close others
        document.querySelectorAll('.fullscreen-overlay').forEach(o => o.classList.remove('visible'));
        // Toggle target
        if(!isVisible) el.classList.add('visible');
    }

    // --- CORE DATA FUNCTIONS (Preserved Logic) ---
    function createNode(x, y, title = 'New Task') {
        return {
            id: 'task_' + Date.now() + Math.random().toString(36).substr(2, 5),
            title: title, description: '', x: x || 100, y: y || 100,
            duration: 1, dueDate: '', syncDurationDate: true,
            completed: false, completedDate: null, isManualUrgent: false,
            dependencies: [], subtasks: [], activeTimerStart: null, timeLogs: []
        };
    }

    function createGoal(text) {
        return { id: 'goal_' + Date.now() + Math.random().toString(36).substr(2, 5), text: text, collapsed: false, children: [] };
    }
    
    function createNoteObject(title, body = "", taskId = null) {
        return { id: 'note_' + Date.now() + Math.random().toString(36).substr(2, 5), title: title || "New Note", body: body, taskId: taskId, timestamp: Date.now() };
    }

    function initDemoData() {
        nodes = [{ id: '1', title: 'Tap to Edit', x: 0, y: 0, completed: false, duration: 1, dueDate: '', syncDurationDate: true, isManualUrgent: false, dependencies: [], subtasks: [], activeTimerStart: null, timeLogs: [] }];
        saveToStorage();
    }

    // --- RENDER GRAPH (Mobile Adjusted) ---
    function render() {
        const container = document.getElementById('nodes-layer'); const svg = document.getElementById('connections');
        container.innerHTML = ''; svg.innerHTML = '';
        
        nodes.forEach(node => {
            node.dependencies.forEach(dep => {
                const parent = nodes.find(n => n.id === dep.id); if (!parent) return; 
                const isCritical = node._isCritical && parent._isCritical && dep.type === 'hard' && !parent.completed;
                const isUrgentPath = node._isUrgent && parent._isUrgent;
                let color = '#444'; 
                if (dep.type === 'soft') color = 'var(--soft-dep-color)'; 
                if (isUrgentPath) color = '#ff4d4d'; else if (isCritical) color = 'var(--critical-path)';
                const width = (isCritical || isUrgentPath) ? 3 : 2;
                
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                // Adjusted bezier anchors for mobile node size (width 160)
                const startX = parent.x + 160; const startY = parent.y + 40; 
                const endX = node.x; const endY = node.y + 40;
                const d = `M ${startX} ${startY} C ${startX + 30} ${startY}, ${endX - 30} ${endY}, ${endX} ${endY}`;
                path.setAttribute('d', d); path.setAttribute('stroke', color); path.setAttribute('stroke-width', width);
                if (dep.type === 'soft') path.classList.add('soft'); if (isCritical || isUrgentPath) path.classList.add('critical');
                svg.appendChild(path);
            });
        });
        
        nodes.forEach(node => {
            const el = document.createElement('div'); el.className = 'node'; 
            el.style.left = node.x + 'px'; el.style.top = node.y + 'px'; 
            
            if (node.id === selectedNodeId) el.classList.add('selected');
            if (!node.completed) { 
                if (node._isUrgent) el.classList.add('critical-urgent'); 
                else if (node._isCritical) el.classList.add('critical'); 
                if (node._isBlocked) el.classList.add('blocked'); 
            } else { el.classList.add('completed'); }

            let badgesHtml = '';
            if (!node.completed) { 
                if (node._isUrgent) badgesHtml += `<span class="badge urgent-badge">URGENT</span>`; 
                else if (node._isCritical) badgesHtml += `<span class="badge critical-badge">CP</span>`; 
            }
            
            const totalTime = getTotalTime(node); const isActive = !!node.activeTimerStart;
            if (totalTime > 0 || isActive) { badgesHtml += `<span class="badge time-badge ${isActive?'active':''}" data-node-id="${node.id}">${isActive ? 'üî¥' : '‚è±'} ${formatTime(totalTime)}</span>`; }
            
            if (node.dueDate && !node.completed) { 
                const due = new Date(node.dueDate); const today = new Date(); today.setHours(0,0,0,0);
                const isOverdue = due < today; 
                const dateStr = due.toLocaleDateString(undefined, {month:'numeric', day:'numeric'}); 
                const style = isOverdue ? 'background:#ef4444; color:white;' : ''; 
                badgesHtml += `<span class="badge" style="${style}">üìÖ ${dateStr}</span>`; 
            }

            let icon = node.completed ? '‚úÖ' : (node._isBlocked ? 'üîí' : '');
            const totalSubs = node.subtasks.length; const doneSubs = node.subtasks.filter(s => s.done).length; 
            const progress = totalSubs === 0 ? 0 : (doneSubs / totalSubs) * 100;

            el.innerHTML = `
                <div class="node-header">${icon} ${node.title}</div>
                <div class="node-meta">${badgesHtml}</div>
                ${totalSubs > 0 ? `<div class="progress-container"><div class="progress-bar" style="width: ${progress}%"></div></div>` : ''}
            `;
            
            // Touch Start for Drag
            el.addEventListener('touchstart', (e) => startNodeDrag(e, node.id), {passive: false});
            el.addEventListener('mousedown', (e) => startNodeDrag(e, node.id));
            
            container.appendChild(el);
        });
        
        updateTransform();
    }

    // --- INTERACTIONS (TOUCH & MOUSE) ---
    function setupInteractions() {
        const container = document.getElementById('graph-container');

        // Touch Panning & Pinching
        container.addEventListener('touchstart', (e) => {
            if (e.target === container || e.target.tagName === 'svg' || e.target.id === 'nodes-layer') {
                if (e.touches.length === 1) {
                    isPanning = true;
                    lastTouchX = e.touches[0].clientX;
                    lastTouchY = e.touches[0].clientY;
                    deselectNode();
                } else if (e.touches.length === 2) {
                    // Pinch Zoom
                    isPanning = false;
                    initialPinchDist = getPinchDistance(e);
                    initialScale = scale;
                }
            }
        }, {passive: false});

        container.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Stop screen scroll
            if (isDragging && draggedNodeId) {
                const currentX = (e.touches[0].clientX - panX) / scale;
                const currentY = (e.touches[0].clientY - panY) / scale;
                const dx = currentX - dragStartX;
                const dy = currentY - dragStartY;
                const node = nodes.find(n => n.id === draggedNodeId);
                if (node) { node.x += dx; node.y += dy; }
                dragStartX = currentX; dragStartY = currentY;
                render();
            } else if (isPanning && e.touches.length === 1) {
                const dx = e.touches[0].clientX - lastTouchX;
                const dy = e.touches[0].clientY - lastTouchY;
                panX += dx; panY += dy;
                lastTouchX = e.touches[0].clientX;
                lastTouchY = e.touches[0].clientY;
                updateTransform();
            } else if (e.touches.length === 2 && initialPinchDist) {
                const dist = getPinchDistance(e);
                const zoomFactor = dist / initialPinchDist;
                scale = Math.min(Math.max(0.2, initialScale * zoomFactor), 3);
                updateTransform();
            }
        }, {passive: false});

        container.addEventListener('touchend', () => { 
            if (isDragging) saveToStorage(); // Only save if dragging occurred
            isDragging = false; 
            isPanning = false; 
            initialPinchDist = null; 
            draggedNodeId = null; 
        });

        // Mouse Fallbacks
        container.addEventListener('mousedown', (e) => {
             if (e.target === container || e.target.tagName === 'svg' || e.target.id === 'nodes-layer') {
                isPanning = true; dragStartX = e.clientX - panX; dragStartY = e.clientY - panY; deselectNode();
             }
        });
        window.addEventListener('mousemove', (e) => {
            if (isPanning) { panX = e.clientX - dragStartX; panY = e.clientY - dragStartY; updateTransform(); }
            if (isDragging && draggedNodeId) {
                const currentX = (e.clientX - panX) / scale;
                const currentY = (e.clientY - panY) / scale;
                const dx = currentX - dragStartX; const dy = currentY - dragStartY;
                const node = nodes.find(n => n.id === draggedNodeId);
                if(node) { node.x += dx; node.y += dy; }
                dragStartX = currentX; dragStartY = currentY;
                render();
            }
        });
        window.addEventListener('mouseup', () => { if(isDragging) saveToStorage(); isDragging = false; isPanning = false; draggedNodeId = null; });
        container.addEventListener('wheel', (e) => { e.preventDefault(); const delta = -e.deltaY; scale = Math.min(Math.max(0.2, scale + (delta * 0.001)), 3); updateTransform(); }, {passive: false});
    }

    function startNodeDrag(e, id) {
        e.stopPropagation();
        const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
        const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
        
        isDragging = true; draggedNodeId = id;
        dragStartX = (clientX - panX) / scale;
        dragStartY = (clientY - panY) / scale;
        selectNode(id);
    }

    function getPinchDistance(e) { return Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY); }
    function updateTransform() { document.getElementById('transform-layer').style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`; }
    
    // --- NODE OPERATIONS ---
    function addNode() { 
        const worldX = (window.innerWidth/2 - panX) / scale - 80; 
        const worldY = (window.innerHeight/2 - panY) / scale - 40; 
        const n = createNode(worldX, worldY); 
        nodes.push(n); updateCalculations(); render(); selectNode(n.id); saveToStorage(); 
    }

    function selectNode(id) { 
        selectedNodeId = id; 
        const inspector = document.getElementById('inspector');
        inspector.classList.add('visible');
        updateInspector(); 
    }
    
    function deselectNode() { 
        selectedNodeId = null; 
        document.getElementById('inspector').classList.remove('visible');
        render(); 
    }

    function fitView() {
        if(nodes.length === 0) return;
        let target = nodes.find(n => n.isManualUrgent && !n.completed) || nodes[0];
        scale = 1;
        panX = (window.innerWidth / 2) - (target.x + 80);
        panY = (window.innerHeight / 2) - (target.y + 40);
        updateTransform();
        showNotification("Recalibrated View");
    }

    // --- INSPECTOR LOGIC ---
    function updateInspector() {
        const panel = document.getElementById('insp-content'); if (!selectedNodeId) return;
        let node = nodes.find(n => n.id === selectedNodeId);
        let isArchived = false;
        if (!node) { node = archivedNodes.find(n => n.id === selectedNodeId); isArchived = true; }
        if (!node) return;
        
        const isRunning = !!node.activeTimerStart;

        panel.innerHTML = `
            ${isArchived ? '<div style="background:#444; color:#fff; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center;">üîí Archived Task</div>' : ''}
            
            <div class="form-group"><label>Title</label><input type="text" value="${node.title}" oninput="updateNodeField('title', this.value)"></div>
            
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div style="flex:1;"><label>Days</label><input type="number" value="${node.duration}" min="1" onchange="updateNodeField('duration', parseInt(this.value))"></div>
                <div style="flex:1;"><label>Status</label><button class="btn ${node.completed ? 'btn-primary' : ''}" style="margin:0; height:46px; border:1px solid #555" onclick="toggleCompletion()">${node.completed ? 'Done' : 'Active'}</button></div>
            </div>

            <div class="form-group">
                <label>Due Date</label>
                <input type="date" value="${node.dueDate || ''}" onchange="updateNodeField('dueDate', this.value)">
                <div style="margin-top:5px; display:flex; align-items:center;">
                    <input type="checkbox" id="sync-chk" ${node.syncDurationDate ? 'checked' : ''} onchange="updateNodeField('syncDurationDate', this.checked)" style="width:20px; height:20px;">
                    <label for="sync-chk" style="margin:0 0 0 10px; display:inline;">Link Duration & Date</label>
                </div>
            </div>
            
            <button class="btn btn-danger" style="border: 1px solid #ef4444; background: ${node.isManualUrgent ? '#ef4444' : 'rgba(239, 68, 68, 0.1)'}; color: ${node.isManualUrgent ? 'white' : '#ef4444'};" onclick="toggleUrgency()">
                ${node.isManualUrgent ? 'üî• Urgent Priority' : 'Mark as Urgent'}
            </button>

            <div class="form-group" style="margin-top:20px;">
                <label>Dependencies</label>
                <select onchange="addDependency(this.value)" style="margin-bottom:10px;">
                    <option value="">+ Add Parent Task...</option>
                    ${nodes.filter(n => n.id !== node.id && !node.dependencies.some(d => d.id === n.id)).map(n => `<option value="${n.id}">${n.title}</option>`).join('')}
                </select>
                <div>${node.dependencies.map(d => { 
                    const p = nodes.find(n => n.id === d.id); 
                    return p ? `<div style="background:#222; padding:8px; margin-bottom:4px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;"><span>${p.title}</span><span onclick="removeDependency('${d.id}')" style="color:red; padding:5px;">‚úï</span></div>` : ''; 
                }).join('')}</div>
            </div>

            <div class="form-group">
                <label>Subtasks</label>
                <div id="subtask-list">${node.subtasks.map((st, idx) => `<div style="display:flex; align-items:center; background:#222; padding:8px; margin-bottom:5px; border-radius:4px;"><input type="checkbox" ${st.done ? 'checked' : ''} onchange="toggleSubtask(${idx})" style="width:20px; height:20px; margin-right:10px;"><input type="text" value="${st.text}" onchange="updateSubtaskText(${idx}, this.value)" style="border:none; background:transparent; padding:0;"><span onclick="removeSubtask(${idx})" style="padding:5px; color:#666">‚úï</span></div>`).join('')}</div>
                <button class="btn" onclick="addSubtask()">+ Subtask</button>
            </div>
            
            <div style="background:#222; padding:15px; border-radius:8px; margin-top:20px;">
                <label>Timer: ${formatTime(getTotalTime(node))}</label>
                <button class="btn ${isRunning ? 'btn-danger' : 'btn-primary'}" onclick="toggleTimer()">
                    ${isRunning ? 'Stop Timer' : 'Start Timer'}
                </button>
            </div>

            <div style="margin-top:30px; margin-bottom:50px;">
                <button class="btn" style="border-color:#666; color:#aaa; margin-bottom:10px;" onclick="demoteToInbox()">‚¨á Move to Inbox</button>
                <button class="btn btn-danger" onclick="deleteSelectedNode()">Delete Task</button>
            </div>
        `;
    }

    // --- LOGIC HELPERS ---
    function updateNodeField(field, value) {
        let node = nodes.find(n => n.id === selectedNodeId);
        if (node) {
            node[field] = value;
            // Sync Logic
            if (node.syncDurationDate) {
                const today = new Date(); today.setHours(0,0,0,0);
                if (field === 'duration') { 
                     const newDate = new Date(today); newDate.setDate(today.getDate() + parseInt(value)); 
                     node.dueDate = newDate.toISOString().split('T')[0];
                } else if (field === 'dueDate' && value) {
                    const diff = Math.ceil((new Date(value) - today) / (1000 * 60 * 60 * 24));
                    node.duration = Math.max(1, diff);
                }
            }
            updateCalculations(); render(); updateInspector(); saveToStorage();
        }
    }

    function toggleCompletion() {
        let node = nodes.find(n => n.id === selectedNodeId);
        let inArchive = false;
        if (!node) { node = archivedNodes.find(n => n.id === selectedNodeId); inArchive = true; }
        if (node) {
            node.completed = !node.completed;
            node.completedDate = node.completed ? Date.now() : null;
            if (!node.completed && inArchive) {
                archivedNodes = archivedNodes.filter(n => n.id !== node.id);
                nodes.push(node);
                renderArchiveList();
            }
            updateCalculations(); render(); updateInspector(); saveToStorage();
        }
    }

    function deleteSelectedNode() {
        if(confirm("Delete task?")) {
            nodes = nodes.filter(n => n.id !== selectedNodeId);
            nodes.forEach(n => { n.dependencies = n.dependencies.filter(d => d.id !== selectedNodeId); });
            deselectNode(); updateCalculations(); render(); saveToStorage();
        }
    }
    
    // --- GENERIC HELPERS (Same as original) ---
    function updateCalculations() {
        nodes.forEach(n => { n._isBlocked = false; n._isReady = false; n._isCritical = false; n._isUrgent = false; n._earliestFinish = 0; n._latestFinish = Infinity; });
        // Blocked status
        nodes.forEach(n => { if(n.completed) return; const parents = n.dependencies.filter(d=>d.type==='hard').map(d=>nodes.find(p=>p.id===d.id)).filter(p=>p); if(parents.length && !parents.every(p=>p.completed)) n._isBlocked = true; });
        // Forward Pass
        let changed = true, iter = 0;
        while(changed && iter < nodes.length+2) { changed = false; nodes.forEach(n => { let maxEF = 0; n.dependencies.forEach(d=>{ const p = nodes.find(x=>x.id===d.id); if(p && p._earliestFinish > maxEF) maxEF = p._earliestFinish; }); const dur = n.completed?0:n.duration; if(n._earliestFinish !== maxEF + dur) { n._earliestFinish = maxEF+dur; changed=true; } }); iter++; }
        // Backward Pass
        const projDur = Math.max(...nodes.map(n=>n._earliestFinish), 0);
        changed = true; iter = 0;
        while(changed && iter < nodes.length+2) { changed=false; nodes.forEach(n => { const children = nodes.filter(c=>c.dependencies.some(d=>d.id===n.id)); let lf = Infinity; if(!children.length) lf = projDur; else lf = Math.min(...children.map(c=>c._latestFinish - (c.completed?0:c.duration))); if(n.dueDate) { const d = Math.ceil((new Date(n.dueDate)-new Date().setHours(0,0,0,0))/(86400000)); if(d < lf) lf = d; } if(n._latestFinish !== lf) { n._latestFinish = lf; changed=true; } }); iter++; }
        // Criticality
        nodes.forEach(n => { if(!n.completed) { if(n.isManualUrgent) n._isUrgent=true; else if(n._latestFinish - n._earliestFinish <= 0) n._isCritical=true; }});
    }

    function saveGithubToken(val) { githubToken = val.trim(); saveToStorage(); showNotification('Token saved locally.'); }

    function saveToStorage() { localStorage.setItem('urgencyFlowData', JSON.stringify({ nodes, archivedNodes, inbox, lifeGoals, notes, githubToken, gistId })); showNotification("Saved"); }
    function loadFromStorage() { 
        const d = JSON.parse(localStorage.getItem('urgencyFlowData')); 
        if(d) { nodes = d.nodes||[]; inbox = d.inbox||[]; lifeGoals = d.lifeGoals||[]; notes = d.notes||[]; archivedNodes = d.archivedNodes||[]; githubToken = d.githubToken||''; gistId = d.gistId||''; }
    }
    function showNotification(msg) { const n = document.getElementById('notification'); n.innerText = msg; n.style.opacity = '1'; setTimeout(() => n.style.opacity = '0', 1500); }
    
    // --- ADDITIONAL LIST RENDERERS ---
    function renderInbox() {
        const div = document.getElementById('inbox-list'); div.innerHTML = '';
        inbox.forEach((item, idx) => {
            div.innerHTML += `<div class="inbox-item"><span>${item.title}</span><div class="inbox-actions"><span onclick="promoteInboxTask(${idx})">‚¨Ü</span><span onclick="promoteInboxToGoal(${idx})">üéØ</span><span onclick="deleteInboxTask(${idx})" style="color:#ef4444">‚úï</span></div></div>`;
        });
    }
    function promoteInboxTask(idx) { 
        const item = inbox[idx]; inbox.splice(idx, 1); 
        nodes.push(createNode((window.innerWidth/2-panX)/scale, (window.innerHeight/2-panY)/scale, item.title));
        saveToStorage(); renderInbox(); render(); showNotification("Task promoted");
    }
    function promoteInboxToGoal(idx) { 
        const item = inbox[idx]; if(!lifeGoals[currentGoalYear]) lifeGoals[currentGoalYear] = []; 
        lifeGoals[currentGoalYear].push(createGoal(item.title)); inbox.splice(idx, 1); 
        renderInbox(); renderGoals(); toggleOverlay('goals-overlay'); saveToStorage(); showNotification("Goal Created");
    }
    function deleteInboxTask(idx) { inbox.splice(idx,1); saveToStorage(); renderInbox(); }
    
    // --- GOALS, NOTES, ARCHIVE WRAPPERS ---
    function renderGoals() {
        const c = document.getElementById('goal-tree-container'); c.innerHTML = '';
        const goals = lifeGoals[currentGoalYear] || [];
        if(!goals.length) c.innerHTML = '<div style="color:#666; text-align:center">No goals set for this year.</div>';
        
        const listContainer = document.createElement('div');
        const appendGoals = (list, container) => {
            list.forEach(g => {
                const node = document.createElement('div'); node.className = 'goal-node';
                const content = document.createElement('div'); content.className = 'goal-content';
                
                content.innerHTML = `<span style="width:20px; color:#888; display:inline-block; text-align:center;">${g.children.length ? (g.collapsed ? '‚ñ∂' : '‚ñº') : '‚Ä¢'}</span>`;
                const caret = content.querySelector('span');
                caret.onclick = (e) => { e.stopPropagation(); g.collapsed = !g.collapsed; renderGoals(); saveToStorage(); };
                
                const input = document.createElement('input'); input.className = 'goal-text'; input.value = g.text;
                input.onchange = (e) => { g.text = e.target.value; saveToStorage(); };
                
                const addSub = document.createElement('span'); addSub.innerText = '+'; addSub.style.padding='10px'; 
                addSub.onclick = () => { g.children.push(createGoal("Subgoal")); g.collapsed = false; renderGoals(); saveToStorage(); };
                
                const delBtn = document.createElement('span'); delBtn.innerText = '‚úï'; delBtn.style.color='#666'; delBtn.style.padding='10px';
                delBtn.onclick = () => { if(confirm("Delete goal?")) { const idx = list.indexOf(g); list.splice(idx,1); renderGoals(); saveToStorage(); } };

                content.appendChild(input); content.appendChild(addSub); content.appendChild(delBtn);
                node.appendChild(content);
                
                if(g.children.length && !g.collapsed) { 
                    const childDiv = document.createElement('div'); childDiv.className='goal-children'; 
                    appendGoals(g.children, childDiv); node.appendChild(childDiv); 
                }
                container.appendChild(node);
            });
        };
        appendGoals(goals, listContainer);
        c.appendChild(listContainer);
    }
    function addRootGoal() { 
        const txt = document.getElementById('new-goal-input').value.trim();
        if(txt) { if(!lifeGoals[currentGoalYear]) lifeGoals[currentGoalYear] = []; lifeGoals[currentGoalYear].push(createGoal(txt)); document.getElementById('new-goal-input').value=''; renderGoals(); saveToStorage(); }
    }
    
    function renderNotesList() {
        const d = document.getElementById('notes-list-container'); d.innerHTML = '';
        notes.sort((a,b)=>b.timestamp-a.timestamp).forEach(n => {
            d.innerHTML += `<div onclick="openNoteEditor('${n.id}')" style="background:#222; padding:15px; border-radius:8px; margin-bottom:10px;"><div style="font-weight:bold">${n.title}</div><div style="font-size:12px; color:#888; margin-top:5px;">${n.body.substring(0,50)}...</div></div>`;
        });
    }
    function createNewNote(tid) { notes.push(createNoteObject("New Note", "", tid)); saveToStorage(); renderNotesList(); openNoteEditor(notes[notes.length-1].id); }
    function openNoteEditor(id) { 
        currentEditingNoteId = id; const n = notes.find(x=>x.id===id); 
        document.getElementById('note-title-input').value = n.title;
        document.getElementById('note-body-input').value = n.body;
        document.getElementById('note-editor').classList.add('visible');
    }
    function closeNoteEditor() { document.getElementById('note-editor').classList.remove('visible'); currentEditingNoteId=null; renderNotesList(); }
    function saveCurrentNote() {
        if(currentEditingNoteId) {
            const n = notes.find(x=>x.id===currentEditingNoteId);
            n.title = document.getElementById('note-title-input').value;
            n.body = document.getElementById('note-body-input').value;
            n.timestamp = Date.now(); saveToStorage();
        }
    }
    function deleteCurrentNote() { notes = notes.filter(n=>n.id!==currentEditingNoteId); closeNoteEditor(); saveToStorage(); }

    function renderArchiveList() {
        const d = document.getElementById('archive-list-container'); d.innerHTML = '';
        archivedNodes.forEach(n => {
            d.innerHTML += `<div class="inbox-item" onclick="selectedNodeId='${n.id}'; toggleArchivePanel(); selectNode('${n.id}');"><span>${n.title}</span><span style="font-size:10px; color:#666">${new Date(n.completedDate).toLocaleDateString()}</span></div>`;
        });
    }

    function toggleUrgency() {
        const node = nodes.find(n => n.id === selectedNodeId);
        if(node) { node.isManualUrgent = !node.isManualUrgent; updateCalculations(); render(); updateInspector(); saveToStorage(); }
    }
    
    function demoteToInbox() {
        const node = nodes.find(n => n.id === selectedNodeId);
        if(node) {
            inbox.push({id:'inbox_'+Date.now(), title:node.title});
            deleteSelectedNode(); // This handles removing and saving
            renderInbox(); showNotification("Moved to Inbox");
        }
    }

    // --- TIMING ---
    function toggleTimer() {
        const node = nodes.find(n => n.id === selectedNodeId);
        if(node) {
            if(node.activeTimerStart) { node.timeLogs.push({start:node.activeTimerStart, end:Date.now(), duration:Date.now()-node.activeTimerStart}); node.activeTimerStart=null; }
            else node.activeTimerStart=Date.now();
            updateInspector(); render(); saveToStorage();
        }
    }
    function tickTimers() {
        nodes.forEach(n => { if(n.activeTimerStart) {
             const badge = document.querySelector(`.time-badge[data-node-id="${n.id}"]`);
             if(badge) badge.innerHTML = `üî¥ ${formatTime(getTotalTime(n))}`;
        }});
    }
    function getTotalTime(n) { return n.timeLogs.reduce((a,b)=>a+b.duration,0) + (n.activeTimerStart?Date.now()-n.activeTimerStart:0); }
    function formatTime(ms) { const m = Math.floor(ms/60000); const h = Math.floor(m/60); return h>0 ? `${h}h ${m%60}m` : `${m}m ${Math.floor((ms%60000)/1000)}s`; }
    function addSubtask() { const n=nodes.find(x=>x.id===selectedNodeId); n.subtasks.push({text:'Step',done:false}); updateInspector(); saveToStorage(); render(); }
    function toggleSubtask(i) { const n=nodes.find(x=>x.id===selectedNodeId); n.subtasks[i].done=!n.subtasks[i].done; updateInspector(); saveToStorage(); }
    function removeSubtask(i) { const n=nodes.find(x=>x.id===selectedNodeId); n.subtasks.splice(i,1); updateInspector(); saveToStorage(); }
    function updateSubtaskText(i,v) { const n=nodes.find(x=>x.id===selectedNodeId); n.subtasks[i].text=v; saveToStorage(); }
    function addDependency(pid) { const n=nodes.find(x=>x.id===selectedNodeId); if(pid && !n.dependencies.find(d=>d.id===pid)) { n.dependencies.push({id:pid, type:'hard'}); updateCalculations(); render(); updateInspector(); saveToStorage(); }}
    function removeDependency(pid) { const n=nodes.find(x=>x.id===selectedNodeId); n.dependencies=n.dependencies.filter(d=>d.id!==pid); updateCalculations(); render(); updateInspector(); saveToStorage(); }
    
    // --- HEATMAP ---
    function renderHeatmap() {
        const c = document.getElementById('heatmap-container'); c.innerHTML='';
        const counts = {}; [...nodes, ...archivedNodes].forEach(n => { if(n.dueDate) counts[n.dueDate] = (counts[n.dueDate]||0)+1; });
        const year = currentHeatmapYear; document.getElementById('heatmap-title').innerText = year;
        for(let m=0; m<12; m++) {
            const mDiv = document.createElement('div'); mDiv.style.background='#222'; mDiv.style.padding='5px'; mDiv.style.borderRadius='4px';
            mDiv.innerHTML = `<div style="font-weight:bold; font-size:10px; margin-bottom:5px;">${new Date(year,m).toLocaleString('default',{month:'short'})}</div>`;
            const grid = document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(7,1fr)'; grid.style.gap='2px';
            const days = new Date(year, m+1, 0).getDate();
            for(let d=1; d<=days; d++) {
                const date = `${year}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const val = counts[date] || 0;
                let col = '#333'; if(val>0) col='#1e3a8a'; if(val>2) col='#3b82f6';
                grid.innerHTML += `<div style="width:100%; aspect-ratio:1; background:${col}; border-radius:1px;"></div>`;
            }
            mDiv.appendChild(grid); c.appendChild(mDiv);
        }
    }
    function changeHeatmapYear(d) { currentHeatmapYear+=d; renderHeatmap(); }
    function checkAutoArchive() {
        const now = Date.now();
        const toArchive = nodes.filter(n => n.completed && n.completedDate && (now - n.completedDate > ARCHIVE_THRESHOLD_MS));
        if (toArchive.length > 0) {
            nodes = nodes.filter(n => !toArchive.includes(n));
            archivedNodes.push(...toArchive);
            saveToStorage(); render();
        }
    }

    // --- SYNC ---
    async function pushToGist() {
        if (!githubToken) return showNotification('Error: Missing GitHub Token');
        showNotification('Pushing to GitHub...');
        const content = JSON.stringify({ nodes, archivedNodes, inbox, lifeGoals, notes }, null, 2);
        const files = {}; files[GIST_FILENAME] = { content: content };
        try {
            let url = 'https://api.github.com/gists'; let method = 'POST';
            if (gistId) { url = `https://api.github.com/gists/${gistId}`; method = 'PATCH'; }
            const response = await fetch(url, { method: method, headers: { 'Authorization': `token ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }, body: JSON.stringify({ description: 'Urgency Flow Data Backup', public: false, files: files }) });
            if (!response.ok) throw new Error('GitHub API Error: ' + response.statusText);
            const data = await response.json();
            gistId = data.id; document.getElementById('gist-id').value = gistId; saveToStorage();
            showNotification('Success! Saved to Gist.');
        } catch (e) { console.error(e); showNotification('Sync Failed: ' + e.message); }
    }

    async function pullFromGist() {
        if (!githubToken) return showNotification('Error: Missing GitHub Token');
        showNotification('Searching for Gist...');
        try {
            if (!gistId) {
                const listResp = await fetch('https://api.github.com/gists', { headers: { 'Authorization': `token ${githubToken}` } });
                if (!listResp.ok) throw new Error('Could not list Gists');
                const gists = await listResp.json();
                const found = gists.find(g => g.files[GIST_FILENAME]);
                if (found) { gistId = found.id; document.getElementById('gist-id').value = gistId; showNotification('Found Gist. Downloading...'); } 
                else { return showNotification('No Gist found. Push first.'); }
            }
            const resp = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { 'Authorization': `token ${githubToken}` } });
            if (!resp.ok) throw new Error('Fetch failed');
            const data = await resp.json();
            const fileContent = data.files[GIST_FILENAME].content;
            const parsed = JSON.parse(fileContent);
            if (parsed.nodes) nodes = parsed.nodes;
            if (parsed.archivedNodes) archivedNodes = parsed.archivedNodes;
            if (parsed.inbox) inbox = parsed.inbox;
            if (parsed.lifeGoals) lifeGoals = parsed.lifeGoals;
            if (parsed.notes) notes = parsed.notes;
            nodes.forEach(n => { if(!n.dependencies) n.dependencies = []; });
            saveToStorage(); updateCalculations(); render(); renderInbox(); renderGoals();
            showNotification('Pull Complete! Data updated.');
        } catch (e) { console.error(e); showNotification('Pull Failed: ' + e.message); }
    }

    function saveData(dl) { const d = JSON.stringify({nodes, archivedNodes, inbox, lifeGoals, notes}); if(dl) { const b = new Blob([d],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='backup.json'; a.click(); } }
    function clearData() { if(confirm("Reset all data?")) { localStorage.clear(); location.reload(); } }

</script>
</body>
</html>
